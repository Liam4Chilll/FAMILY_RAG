<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family RAG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        /* === THEMES === */
        :root, [data-theme="midnight"] {
            --accent-400: #3b82f6; --accent-500: #2563eb; --accent-600: #1d4ed8; --accent-700: #1e40af;
            --bg-primary: #0a1628; --bg-secondary: #0f1f3a; --bg-tertiary: #152845;
            --border-color: #1e3a5f; --text-primary: #ffffff; --text-secondary: #94a3b8;
        }
        [data-theme="cyber"] {
            --accent-400: #22d3ee; --accent-500: #00d4ff; --accent-600: #0891b2; --accent-700: #0e7490;
            --bg-primary: #000000; --bg-secondary: #0a0a0a; --bg-tertiary: #141414;
            --border-color: #00d4ff; --text-primary: #ffffff; --text-secondary: #64748b;
        }
        [data-theme="tactical"] {
            --accent-400: #ff6666; --accent-500: #ff3333; --accent-600: #dc2626; --accent-700: #b91c1c;
            --bg-primary: #1a2e1a; --bg-secondary: #253825; --bg-tertiary: #2d442d;
            --border-color: #3d5a3d; --text-primary: #ffffff; --text-secondary: #86a386;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
        }
        .bg-card { background-color: var(--bg-secondary); }
        .bg-elevated { background-color: var(--bg-tertiary); }
        .border-themed { border-color: var(--border-color); }
        .text-muted { color: var(--text-secondary); }
        .gradient-accent { background: linear-gradient(135deg, var(--accent-500), var(--accent-700)); }
        .text-accent { color: var(--accent-400); }

        /* === SCROLLBAR === */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--accent-500); border-radius: 3px; }

        /* === RANGE SLIDER === */
        input[type="range"] {
            -webkit-appearance: none;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, var(--accent-500), var(--accent-700));
            border-radius: 50%;
            box-shadow: 0 0 10px var(--accent-500);
        }

        /* === FLOATING SHAPES (ENHANCED) === */
        .floating-shapes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }
        .shape {
            position: absolute;
            opacity: 0.20;
            border: 3px solid var(--accent-500);
            filter: drop-shadow(0 0 10px var(--accent-500));
        }
        .shape-diamond {
            width: 100px;
            height: 100px;
            transform: rotate(45deg);
            border-radius: 10px;
            background: radial-gradient(circle at center, transparent 40%, var(--accent-500) 100%);
        }
        .shape-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: radial-gradient(circle at center, transparent 50%, var(--accent-500) 100%);
        }
        .shape-triangle {
            width: 0;
            height: 0;
            border-left: 60px solid transparent;
            border-right: 60px solid transparent;
            border-bottom: 104px solid var(--accent-500);
            background: transparent;
            filter: drop-shadow(0 0 15px var(--accent-500));
        }

        /* === ANIMATIONS === */
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px var(--accent-500); }
            50% { box-shadow: 0 0 20px var(--accent-500), 0 0 30px var(--accent-600); }
        }
        @keyframes pulse-border {
            0%, 100% { border-color: var(--border-color); }
            50% { border-color: var(--accent-500); }
        }

        .animate-slideIn { animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        .animate-glow { animation: glow 2s ease-in-out infinite; }
        .animate-pulse-border { animation: pulse-border 2s ease-in-out infinite; }

        /* Hover effects */
        .hover-lift {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        [x-cloak] { display: none !important; }

        /* === NOTIFICATIONS TOAST === */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            min-width: 300px;
            max-width: 400px;
            z-index: 9999;
            pointer-events: all;
        }
        .toast-enter {
            animation: slideInRight 0.3s ease-out;
        }
        .toast-leave {
            animation: slideOutRight 0.3s ease-in;
        }
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        /* === COMPACT LAYOUT === */
        .compact-padding { padding: 0.75rem; }
        .compact-gap { gap: 0.5rem; }

        /* === MESSAGE METRICS === */
        .message-metrics {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.75rem;
            opacity: 0.8;
        }

        /* === SIDEBAR === */
        .sidebar {
            position: fixed;
            right: 0;
            top: 0;
            height: 100vh;
            width: 280px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            z-index: 40;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .sidebar.open {
            transform: translateX(0);
        }

        /* === SOURCE SELECTION === */
        .source-checkbox {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-elevated);
            transition: all 0.2s ease;
        }
        .source-checkbox:checked {
            background: var(--accent-500);
            border-color: var(--accent-500);
        }
        .source-checkbox:checked::after {
            content: '‚úì';
            color: white;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* === DRAG AND DROP === */
        .drop-zone {
            transition: all 0.3s ease;
        }
        .drop-zone.drag-over {
            border-color: var(--accent-500) !important;
            background-color: var(--bg-tertiary);
            box-shadow: 0 0 20px rgba(from var(--accent-500) r g b / 0.3);
        }

        /* === IMAGE PREVIEW === */
        .image-preview {
            max-width: 150px;
            max-height: 100px;
            object-fit: contain;
            border-radius: 8px;
        }
    </style>
</head>
<body class="min-h-screen relative">

    <!-- Floating Background Shapes -->
    <div class="floating-shapes" id="floating-bg"></div>

    <div x-data="ragApp()" x-init="init()" class="relative z-10">

        <!-- Sidebar History -->
        <div class="sidebar" :class="{'open': sidebarOpen}">
            <div class="flex flex-col h-full">
                <!-- Sidebar Header -->
                <div class="flex items-center justify-between compact-padding border-b border-themed">
                    <h3 class="font-semibold flex items-center gap-2">
                        <span>üí¨</span> Conversations
                    </h3>
                    <button @click="sidebarOpen = false" class="text-muted hover:text-white">‚úï</button>
                </div>

                <!-- New Conversation Button -->
                <div class="compact-padding border-b border-themed">
                    <button @click="newConversation()" class="w-full gradient-accent text-white compact-padding rounded-lg font-medium hover-lift flex items-center justify-center gap-2">
                        <span>‚ûï</span> Nouvelle conversation
                    </button>
                </div>

                <!-- Conversations List -->
                <div class="flex-1 overflow-y-auto p-2">
                    <template x-for="(conv, index) in conversations" :key="conv.id">
                        <div @click="loadConversation(conv.id)"
                             :class="currentConversationId === conv.id ? 'bg-elevated border-accent' : 'bg-card border-themed hover:border-accent'"
                             class="mb-2 compact-padding rounded-lg border transition-all hover-lift animate-slideIn"
                             :style="'animation-delay: ' + (index * 0.05) + 's'">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm font-medium truncate flex-1" x-text="conv.title"></span>
                                <button @click.stop.prevent="deleteConversation(conv.id)" class="text-muted hover:text-red-400 text-base flex-shrink-0 ml-2 px-1 hover:scale-125 transition-transform">üóëÔ∏è</button>
                            </div>
                            <div class="text-xs text-muted flex items-center gap-2">
                                <span x-text="conv.messages?.length || 0"></span> messages
                                <span>‚Ä¢</span>
                                <span x-text="formatTime(conv.timestamp)"></span>
                            </div>
                        </div>
                    </template>
                    <div x-show="conversations.length === 0" class="text-center text-muted py-8">
                        <p class="text-sm">Aucune conversation</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Container -->
        <div class="container mx-auto px-3 py-4 max-w-7xl">

            <!-- Header -->
            <header class="mb-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 gradient-accent rounded-lg flex items-center justify-center shadow-lg animate-glow">
                            <span class="text-xl">üè†</span>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-accent">Family RAG</h1>
                            <p class="text-muted text-sm">v2.7.0</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span x-show="visionAvailable" class="flex items-center gap-2 bg-card compact-padding rounded-lg border border-themed">
                            <span class="text-sm">üëÅÔ∏è</span>
                            <span class="text-xs text-muted">Vision</span>
                        </span>
                        <button @click="sidebarOpen = !sidebarOpen" class="bg-card compact-padding rounded-lg border border-themed hover:border-accent transition-all">
                            <span class="text-lg">üí¨</span>
                        </button>
                        <span class="flex items-center gap-2 bg-card compact-padding rounded-lg border border-themed">
                            <span class="relative flex h-2 w-2">
                                <span :class="ollamaConnected ? 'bg-green-400' : 'bg-red-400'" class="animate-ping absolute inline-flex h-full w-full rounded-full opacity-75"></span>
                                <span :class="ollamaConnected ? 'bg-green-500' : 'bg-red-500'" class="relative inline-flex rounded-full h-2 w-2"></span>
                            </span>
                            <span class="text-xs text-muted" x-text="ollamaConnected ? 'Ollama' : 'Off'"></span>
                        </span>
                    </div>
                </div>
            </header>

            <!-- Navigation -->
            <nav class="flex gap-1 mb-4 bg-card/50 backdrop-blur p-1 rounded-lg w-fit border border-themed">
                <button @click="activeTab = 'chat'" :class="activeTab === 'chat' ? 'gradient-accent text-white shadow-lg' : 'text-muted hover:text-white hover:bg-elevated'" class="px-4 py-2 rounded-lg transition-all font-medium flex items-center gap-2 text-sm">
                    <span>üí¨</span> Chat
                </button>
                <button @click="activeTab = 'documents'" :class="activeTab === 'documents' ? 'gradient-accent text-white shadow-lg' : 'text-muted hover:text-white hover:bg-elevated'" class="px-4 py-2 rounded-lg transition-all font-medium flex items-center gap-2 text-sm">
                    <span>üìÅ</span> Documents
                </button>
                <button @click="activeTab = 'settings'" :class="activeTab === 'settings' ? 'gradient-accent text-white shadow-lg' : 'text-muted hover:text-white hover:bg-elevated'" class="px-4 py-2 rounded-lg transition-all font-medium flex items-center gap-2 text-sm">
                    <span>‚öôÔ∏è</span> Param√®tres
                </button>
            </nav>

            <!-- Chat Tab -->
            <div x-show="activeTab === 'chat'" x-cloak x-transition>
                <!-- Source Selection -->
                <div x-show="showSourceSelection" x-transition class="mb-4 bg-card/50 backdrop-blur rounded-lg compact-padding border border-themed animate-fadeIn">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold text-sm flex items-center gap-2">
                            <span>üéØ</span> S√©lection des sources
                        </h3>
                        <div class="flex gap-2">
                            <button @click="selectAllSources()" class="text-xs text-accent hover:underline">Tout s√©lectionner</button>
                            <button @click="deselectAllSources()" class="text-xs text-muted hover:text-white">Tout d√©s√©lectionner</button>
                            <button @click="showSourceSelection = false" class="text-muted hover:text-white">‚úï</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 max-h-40 overflow-y-auto">
                        <template x-for="file in files" :key="file.path">
                            <label class="flex items-center gap-2 bg-elevated compact-padding rounded border border-themed hover:border-accent transition-all hover-lift">
                                <input type="checkbox" x-model="selectedSources" :value="file.name" class="source-checkbox">
                                <span class="text-xs truncate" x-text="file.name"></span>
                            </label>
                        </template>
                    </div>
                    <p class="text-xs text-muted mt-2" x-text="selectedSources.length + ' source(s) s√©lectionn√©e(s)'"></p>
                </div>

                <div class="bg-card/50 backdrop-blur rounded-lg compact-padding border border-themed">
                    <!-- Messages -->
                    <div class="h-96 overflow-y-auto mb-3 space-y-2" id="chat-messages">
                        <template x-for="(msg, index) in messages" :key="index">
                            <div :class="msg.type === 'user' ? 'flex justify-end' : 'flex justify-start'" class="animate-fadeIn">
                                <div :class="msg.type === 'user' ? 'gradient-accent text-white' : 'bg-elevated'" class="max-w-[80%] rounded-lg compact-padding shadow-lg hover-lift">
                                    <template x-if="msg.image">
                                        <img :src="msg.image" class="max-w-[150px] max-h-[100px] object-contain rounded mb-2" alt="Image">
                                    </template>
                                    <p class="whitespace-pre-wrap text-sm" x-text="msg.content"></p>
                                    <template x-if="msg.metrics">
                                        <div class="message-metrics">
                                            <span>‚è±Ô∏è <span x-text="((msg.metrics.query_time_ms || msg.metrics.time_ms) / 1000).toFixed(2)"></span>s</span>
                                            <span x-show="msg.metrics.chunks_found">üìÑ <span x-text="msg.metrics.chunks_found"></span> chunks</span>
                                            <span x-show="msg.metrics.confidence">üéØ <span x-text="msg.metrics.confidence"></span>%</span>
                                            <button x-show="msg.chunks_preview" @click="msg.showDebug = !msg.showDebug" class="text-xs text-accent hover:underline ml-2">
                                                <span x-text="msg.showDebug ? 'üîç Masquer chunks' : 'üîç Debug chunks'"></span>
                                            </button>
                                        </div>
                                    </template>
                                    <!-- Debug chunks preview -->
                                    <template x-if="msg.chunks_preview && msg.showDebug">
                                        <div class="mt-2 pt-2 border-t border-white/20">
                                            <p class="text-xs font-semibold mb-2 opacity-80">üîç Chunks r√©cup√©r√©s :</p>
                                            <template x-for="(chunk, idx) in msg.chunks_preview" :key="idx">
                                                <div class="mb-2 p-2 bg-black/20 rounded text-xs">
                                                    <div class="flex justify-between mb-1">
                                                        <span class="font-medium" x-text="chunk.source"></span>
                                                        <span class="text-accent" x-text="(chunk.score * 100).toFixed(1) + '%'"></span>
                                                    </div>
                                                    <p class="opacity-70 text-xs" x-text="chunk.content"></p>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>

                        <!-- Loading -->
                        <div x-show="loading" class="flex justify-start animate-fadeIn">
                            <div class="bg-elevated rounded-lg compact-padding flex items-center gap-3">
                                <div class="flex gap-1">
                                    <span class="w-2 h-2 rounded-full animate-bounce" style="background: var(--accent-400)"></span>
                                    <span class="w-2 h-2 rounded-full animate-bounce" style="background: var(--accent-500); animation-delay: 0.15s"></span>
                                    <span class="w-2 h-2 rounded-full animate-bounce" style="background: var(--accent-600); animation-delay: 0.3s"></span>
                                </div>
                                <button @click="stopGeneration()" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs font-medium">‚èπ Stop</button>
                            </div>
                        </div>

                        <!-- Empty state -->
                        <div x-show="messages.length === 0 && !loading" class="text-center text-muted py-16">
                            <div class="w-16 h-16 mx-auto mb-3 bg-elevated rounded-full flex items-center justify-center">
                                <span class="text-3xl">üìö</span>
                            </div>
                            <p class="text-base">Nouvelle conversation</p>
                            <p class="text-xs mt-2">S√©lectionnez vos sources et posez une question</p>
                        </div>
                    </div>

                    <!-- Source selection trigger -->
                    <button @click="showSourceSelection = !showSourceSelection" class="w-full mb-2 text-xs text-accent hover:bg-elevated compact-padding rounded border border-themed transition-all flex items-center justify-center gap-2">
                        <span>üéØ</span> <span x-text="selectedSources.length + ' source(s) s√©lectionn√©e(s)'"></span>
                    </button>

                    <!-- Image preview before send -->
                    <div x-show="pendingImage" x-transition class="mb-2 compact-padding bg-elevated rounded-lg border border-themed flex items-center gap-2 animate-fadeIn">
                        <img :src="pendingImage" class="image-preview" alt="Preview">
                        <div class="flex-1">
                            <p class="text-xs font-medium">Image pr√™te √† analyser</p>
                            <p class="text-xs text-muted">Vision OCR</p>
                        </div>
                        <button @click="clearPendingImage()" class="text-muted hover:text-red-400">‚úï</button>
                    </div>

                    <!-- Input area with drag & drop -->
                    <div class="drop-zone rounded-lg p-1 border border-themed mb-1"
                         :class="{'drag-over': isDragging}"
                         @dragover.prevent="isDragging = true"
                         @dragleave.prevent="isDragging = false"
                         @drop.prevent="handleDrop($event)">
                        <div class="flex gap-2 items-end">
                            <!-- Upload button -->
                            <label class="bg-elevated hover:bg-tertiary border border-themed rounded-lg compact-padding transition-all flex items-center justify-center hover-lift" :class="{'opacity-50': !visionAvailable}" style="cursor: pointer;">
                                <input type="file" accept="image/*" @change="handleFileSelect($event)" class="hidden" :disabled="!visionAvailable">
                                <span class="text-base">üìé</span>
                            </label>

                            <input type="text" x-model="query"
                                   @keydown.enter="sendMessage()"
                                   placeholder="Posez votre question ou glissez une image..."
                                   :disabled="loading"
                                   class="flex-1 bg-elevated border border-themed rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-accent transition-all disabled:opacity-50"
                                   style="color: var(--text-primary)">

                            <button @click="sendMessage()"
                                    :disabled="loading || (!query.trim() && !pendingImage)"
                                    class="gradient-accent disabled:opacity-50 px-4 py-2 rounded-lg font-medium transition-all text-sm hover-lift animate-glow">
                                <span x-show="!loading">Envoyer</span>
                                <span x-show="loading">...</span>
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-muted text-center" x-show="visionAvailable">üí° Glissez-d√©posez une image ou cliquez sur üìé pour l'analyser avec OCR</p>
                </div>
            </div>

            <!-- Documents Tab -->
            <div x-show="activeTab === 'documents'" x-cloak x-transition>
                <div class="bg-card/50 backdrop-blur rounded-lg compact-padding border border-themed">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 class="text-lg font-semibold flex items-center gap-2">
                                <span class="w-8 h-8 bg-elevated rounded-lg flex items-center justify-center">üìÇ</span>
                                Documents
                            </h2>
                        </div>
                        <div class="flex gap-2">
                            <button @click="refreshFiles()" :disabled="indexing" class="bg-elevated border border-themed compact-padding rounded-lg transition-all flex items-center gap-2 hover:border-accent text-sm">
                                <span :class="{'animate-spin': refreshingFiles}">üîÑ</span> Rafra√Æchir
                            </button>
                            <button @click="indexDocuments()" :disabled="indexing || files.length === 0" class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-500 hover:to-green-600 disabled:from-gray-600 disabled:to-gray-700 compact-padding rounded-lg font-medium transition-all flex items-center gap-2 text-sm animate-glow">
                                <span x-show="!indexing">üì• Indexer</span>
                                <span x-show="indexing" class="flex items-center gap-2">
                                    <svg class="animate-spin h-3 w-3" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    Indexation...
                                </span>
                            </button>
                        </div>
                    </div>

                    <!-- Barre de progression -->
                    <div x-show="indexing" x-transition class="bg-card/50 backdrop-blur rounded-lg compact-padding border border-themed mb-4 animate-fadeIn">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-muted">Indexation en cours...</span>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-accent font-medium" x-text="indexProgress + '%'"></span>
                                <button @click="cancelIndexing()" class="text-xs bg-red-600 hover:bg-red-500 px-2 py-1 rounded transition-all flex items-center gap-1">
                                    <span>‚è∏</span> Suspendre
                                </button>
                            </div>
                        </div>
                        <div class="w-full bg-elevated rounded-full h-2 overflow-hidden">
                            <div class="h-full gradient-accent transition-all duration-300 ease-out" :style="'width: ' + indexProgress + '%'"></div>
                        </div>
                        <p class="text-xs text-muted mt-2 opacity-70" x-text="indexStatus"></p>
                        <p x-show="indexProgress >= 90" class="text-xs text-orange-300 mt-2 opacity-90">üí° L'indexation peut prendre du temps pour les gros fichiers (g√©n√©ration d'embeddings)...</p>
                    </div>

                    <!-- Stats -->
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="bg-elevated rounded-lg compact-padding text-center border border-themed hover-lift">
                            <p class="text-2xl font-bold text-accent" x-text="files.length">0</p>
                            <p class="text-xs text-muted mt-1">Fichiers</p>
                        </div>
                        <div class="bg-elevated rounded-lg compact-padding text-center border border-themed hover-lift">
                            <p class="text-2xl font-bold text-accent" x-text="stats.index.total_chunks">0</p>
                            <p class="text-xs text-muted mt-1">Chunks</p>
                        </div>
                        <div class="bg-elevated rounded-lg compact-padding text-center border border-themed hover-lift">
                            <p class="text-2xl font-bold" :class="stats.index.exists ? 'text-green-400' : 'text-red-400'" x-text="stats.index.exists ? '‚úì' : '‚úó'"></p>
                            <p class="text-xs text-muted mt-1">Index</p>
                        </div>
                    </div>

                    <!-- M√©triques syst√®me -->
                    <div class="bg-gradient-to-br from-card/80 to-elevated/80 backdrop-blur rounded-lg compact-padding border border-themed mb-4 animate-fadeIn">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-semibold flex items-center gap-2">
                                <span class="text-base">üíª</span> M√©triques syst√®me
                            </h3>
                            <span class="text-xs text-muted" x-text="'Mise √† jour : ' + new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit', second: '2-digit'})"></span>
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            <!-- CPU -->
                            <div class="bg-elevated/50 rounded-lg p-2 border border-themed/50">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-xs text-muted">CPU</span>
                                    <span class="text-xs font-bold text-accent" x-text="systemMetrics.cpu.percent + '%'"></span>
                                </div>
                                <div class="w-full bg-card rounded-full h-1.5 overflow-hidden">
                                    <div class="h-full transition-all duration-500" :class="systemMetrics.cpu.percent > 80 ? 'bg-red-500' : systemMetrics.cpu.percent > 50 ? 'bg-orange-500' : 'bg-green-500'" :style="'width: ' + systemMetrics.cpu.percent + '%'"></div>
                                </div>
                                <p class="text-xs text-muted mt-1 opacity-70" x-text="systemMetrics.cpu.count + ' c≈ìurs'"></p>
                            </div>
                            <!-- RAM -->
                            <div class="bg-elevated/50 rounded-lg p-2 border border-themed/50">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-xs text-muted">RAM</span>
                                    <span class="text-xs font-bold text-accent" x-text="systemMetrics.memory.percent + '%'"></span>
                                </div>
                                <div class="w-full bg-card rounded-full h-1.5 overflow-hidden">
                                    <div class="h-full transition-all duration-500" :class="systemMetrics.memory.percent > 80 ? 'bg-red-500' : systemMetrics.memory.percent > 50 ? 'bg-orange-500' : 'bg-green-500'" :style="'width: ' + systemMetrics.memory.percent + '%'"></div>
                                </div>
                                <p class="text-xs text-muted mt-1 opacity-70" x-text="systemMetrics.memory.available_gb + ' Go libre'"></p>
                            </div>
                            <!-- Disque -->
                            <div class="bg-elevated/50 rounded-lg p-2 border border-themed/50">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-xs text-muted">Disque</span>
                                    <span class="text-xs font-bold text-accent" x-text="systemMetrics.disk.percent + '%'"></span>
                                </div>
                                <div class="w-full bg-card rounded-full h-1.5 overflow-hidden">
                                    <div class="h-full transition-all duration-500" :class="systemMetrics.disk.percent > 80 ? 'bg-red-500' : systemMetrics.disk.percent > 50 ? 'bg-orange-500' : 'bg-green-500'" :style="'width: ' + systemMetrics.disk.percent + '%'"></div>
                                </div>
                                <p class="text-xs text-muted mt-1 opacity-70" x-text="systemMetrics.disk.free_gb + ' Go libre'"></p>
                            </div>
                        </div>
                    </div>

                    <!-- FAISS Index Details -->
                    <div class="bg-gradient-to-br from-card/80 to-elevated/80 backdrop-blur rounded-lg compact-padding border border-themed mb-4 animate-fadeIn">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-semibold flex items-center gap-2">
                                <span class="text-base">üóÇÔ∏è</span> √âtat de l'index FAISS
                            </h3>
                            <button @click="fetchIndexDetails()" class="text-xs text-accent hover:underline flex items-center gap-1">
                                <span :class="{'animate-spin': fetchingIndexDetails}">üîÑ</span> Actualiser
                            </button>
                        </div>
                        <div x-show="indexDetails.exists" class="space-y-2">
                            <div class="flex items-center justify-between text-xs">
                                <span class="text-muted">Vecteurs totaux</span>
                                <span class="text-accent font-bold" x-text="indexDetails.total_vectors || 0"></span>
                            </div>
                            <div class="flex items-center justify-between text-xs">
                                <span class="text-muted">Fichiers index√©s</span>
                                <span class="text-accent font-bold" x-text="(indexDetails.indexed_files || []).length"></span>
                            </div>
                            <div class="flex items-center justify-between text-xs">
                                <span class="text-muted">Mod√®le embedding</span>
                                <span class="text-accent font-mono text-xs" x-text="indexDetails.embedding_model || 'N/A'"></span>
                            </div>
                            <!-- Liste des fichiers index√©s (collapsible) -->
                            <details class="mt-2">
                                <summary class="text-xs text-muted cursor-pointer hover:text-accent transition-colors">Voir les fichiers index√©s</summary>
                                <div class="mt-2 space-y-1 max-h-32 overflow-y-auto">
                                    <template x-for="fname in (indexDetails.indexed_files || [])" :key="fname">
                                        <div class="text-xs bg-elevated/50 px-2 py-1 rounded truncate" x-text="fname"></div>
                                    </template>
                                </div>
                            </details>
                        </div>
                        <div x-show="!indexDetails.exists" class="text-xs text-muted text-center py-2">
                            Aucun index FAISS trouv√©. Indexez vos documents pour commencer.
                        </div>
                    </div>

                    <!-- Index result -->
                    <div x-show="indexResult" x-transition :class="indexResult?.success ? 'bg-green-900/30 border-green-500/50' : 'bg-red-900/30 border-red-500/50'" class="border rounded-lg compact-padding mb-4 animate-fadeIn">
                        <p x-show="indexResult?.success" class="flex items-center gap-2 text-sm">‚úÖ <span x-text="indexResult?.documents"></span> documents, <span x-text="indexResult?.chunks"></span> chunks en <span x-text="indexResult?.time_seconds"></span>s</p>
                        <p x-show="indexResult && !indexResult?.success" class="flex items-center gap-2 text-sm">‚ùå <span x-text="indexResult?.error"></span></p>
                    </div>

                    <!-- File Selection Controls -->
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-semibold flex items-center gap-2">
                            <span>üìã</span> S√©lection des fichiers
                            <span class="text-xs text-accent" x-text="'(' + selectedFiles.length + '/' + files.length + ')'"></span>
                        </h3>
                        <div class="flex gap-2">
                            <button @click="selectAllFiles()" class="text-xs text-accent hover:underline">Tout s√©lectionner</button>
                            <button @click="deselectAllFiles()" class="text-xs text-muted hover:text-white">Tout d√©s√©lectionner</button>
                        </div>
                    </div>

                    <!-- Files list with checkboxes -->
                    <div class="space-y-2">
                        <template x-for="(file, index) in files" :key="file.path">
                            <label class="flex items-center justify-between bg-elevated rounded-lg compact-padding border border-themed hover:border-accent transition-all animate-slideIn hover-lift cursor-pointer" :style="'animation-delay: ' + (index * 0.03) + 's'">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" x-model="selectedFiles" :value="file.path" class="source-checkbox">
                                    <span class="text-base" x-text="getFileIcon(file.type)"></span>
                                    <span class="text-sm" x-text="file.name"></span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <!-- Indicateur si index√© -->
                                    <span x-show="(indexDetails.indexed_files || []).includes(file.name)" class="text-xs text-green-400" title="D√©j√† index√©">‚úì</span>
                                    <span class="text-xs text-muted bg-card px-2 py-1 rounded" x-text="formatSize(file.size)"></span>
                                </div>
                            </label>
                        </template>
                        <div x-show="files.length === 0" class="text-center text-muted py-12">
                            <p class="text-sm">Aucun fichier</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div x-show="activeTab === 'settings'" x-cloak x-transition>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Themes -->
                    <div class="bg-card/50 backdrop-blur rounded-lg compact-padding border border-themed md:col-span-2">
                        <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                            <span class="w-8 h-8 bg-elevated rounded-lg flex items-center justify-center">üé®</span>
                            Th√®me
                        </h2>
                        <div class="grid grid-cols-3 gap-3">
                            <template x-for="theme in themes" :key="theme.id">
                                <button @click="setTheme(theme.id)" :class="currentTheme === theme.id ? 'ring-2 ring-offset-2 ring-offset-gray-900 animate-pulse-border' : ''" :style="currentTheme === theme.id ? 'ring-color: ' + theme.accent : ''" class="relative compact-padding rounded-lg border border-themed hover:border-accent transition-all hover-lift">
                                    <div class="w-full h-6 rounded mb-2" :style="'background: linear-gradient(135deg, ' + theme.accent + ', ' + theme.accentDark + ')'"></div>
                                    <p class="text-sm font-medium" x-text="theme.name"></p>
                                    <span x-show="currentTheme === theme.id" class="absolute top-2 right-2 text-green-400">‚úì</span>
                                </button>
                            </template>
                        </div>
                    </div>

                    <!-- LLM Settings -->
                    <div class="bg-card/50 backdrop-blur rounded-lg compact-padding border border-themed">
                        <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                            <span class="w-8 h-8 bg-elevated rounded-lg flex items-center justify-center">ü§ñ</span>
                            Mod√®le LLM
                        </h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs text-muted mb-2">Mod√®le actif (g√©n√©ration)</label>
                                <select x-model="selectedModel" @change="changeModel()" :disabled="ollamaModels.length === 0" class="w-full bg-elevated border border-themed rounded-lg compact-padding text-sm focus:outline-none focus:border-accent transition-all" style="color: var(--text-primary)">
                                    <template x-for="model in ollamaModels" :key="model.name">
                                        <option :value="model.name" x-text="model.name"></option>
                                    </template>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-muted mb-2">Temp√©rature (cr√©ativit√©) : <span class="text-accent" x-text="settings.temperature"></span></label>
                                <input type="range" min="0" max="1" step="0.1" x-model="settings.temperature" @change="updateSettings()" class="w-full">
                                <p class="text-xs text-muted mt-1 opacity-70">0 = pr√©cis, 1 = cr√©atif</p>
                            </div>
                            <div>
                                <label class="block text-xs text-muted mb-2">Chunks (contexte) : <span class="text-accent" x-text="settings.top_k"></span></label>
                                <input type="range" min="1" max="20" step="1" x-model="settings.top_k" @change="updateSettings()" class="w-full">
                                <p class="text-xs text-muted mt-1 opacity-70">Nombre d'extraits utilis√©s pour r√©pondre</p>
                            </div>
                        </div>
                    </div>

                    <!-- Embedding Model Settings -->
                    <div class="bg-card/50 backdrop-blur rounded-lg compact-padding border border-themed">
                        <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                            <span class="w-8 h-8 bg-elevated rounded-lg flex items-center justify-center">üîç</span>
                            Mod√®le Embedding
                        </h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs text-muted mb-2">Mod√®le actif (indexation)</label>
                                <select x-model="selectedEmbeddingModel" @change="changeEmbeddingModel()" :disabled="embeddingModels.length === 0" class="w-full bg-elevated border border-themed rounded-lg compact-padding text-sm focus:outline-none focus:border-accent transition-all" style="color: var(--text-primary)">
                                    <template x-for="model in embeddingModels" :key="model.name">
                                        <option :value="model.name" x-text="model.name"></option>
                                    </template>
                                </select>
                                <p class="text-xs text-muted mt-1 opacity-70">Convertit vos documents en vecteurs pour la recherche</p>
                            </div>
                            <!-- Avertissement r√©-indexation -->
                            <div x-show="needsReindex" x-transition class="bg-orange-900/30 border border-orange-500/50 rounded-lg compact-padding animate-fadeIn">
                                <p class="text-xs text-orange-300 font-medium mb-1">‚ö†Ô∏è R√©-indexation requise</p>
                                <p class="text-xs text-orange-200 opacity-80">Le mod√®le d'embedding a chang√©. Cliquez sur "Indexer" dans l'onglet Documents.</p>
                            </div>
                            <!-- Info chunk size -->
                            <div>
                                <label class="block text-xs text-muted mb-2">Configuration</label>
                                <div class="bg-elevated rounded-lg compact-padding border border-themed text-xs">
                                    <p class="mb-1">Chunk size: <span class="text-accent" x-text="stats.settings.chunk_size"></span> caract√®res</p>
                                    <p>Overlap: <span class="text-accent" x-text="stats.settings.chunk_overlap"></span> caract√®res</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="mt-8 text-center text-muted text-xs">
                <p>Family RAG v2.7 ‚Äî Liam4Chilll</p>
            </footer>
        </div>
    </div>

    <script>
        // === FLOATING SHAPES ===
        function initFloatingShapes() {
            const container = document.getElementById('floating-bg');
            const shapes = [
                { class: 'shape-diamond', size: 100 },
                { class: 'shape-circle', size: 120 },
                { class: 'shape-triangle', size: 104 },
                { class: 'shape-diamond', size: 80 },
                { class: 'shape-circle', size: 100 },
                { class: 'shape-triangle', size: 90 }
            ];

            shapes.forEach((shapeConfig, i) => {
                const shape = document.createElement('div');
                shape.className = `shape ${shapeConfig.class}`;

                const startX = Math.random() * (window.innerWidth - shapeConfig.size);
                const startY = Math.random() * (window.innerHeight - shapeConfig.size);

                shape.style.left = startX + 'px';
                shape.style.top = startY + 'px';

                container.appendChild(shape);

                let x = startX, y = startY;
                let vx = (Math.random() - 0.5) * 2;
                let vy = (Math.random() - 0.5) * 2;
                const size = shapeConfig.size;

                function animate() {
                    x += vx;
                    y += vy;

                    if (x <= 0 || x >= window.innerWidth - size) {
                        vx *= -1;
                        x = Math.max(0, Math.min(x, window.innerWidth - size));
                    }
                    if (y <= 0 || y >= window.innerHeight - size) {
                        vy *= -1;
                        y = Math.max(0, Math.min(y, window.innerHeight - size));
                    }

                    shape.style.left = x + 'px';
                    shape.style.top = y + 'px';

                    requestAnimationFrame(animate);
                }

                setTimeout(animate, i * 200);
            });
        }

        document.addEventListener('DOMContentLoaded', initFloatingShapes);

        // === ALPINE APP ===
        function ragApp() {
            return {
                activeTab: 'chat',
                query: '',
                messages: [],
                loading: false,
                abortController: null,
                indexing: false,
                indexResult: null,
                indexProgress: 0,
                indexStatus: '',
                indexAbortController: null,
                files: [],
                selectedFiles: [],
                indexDetails: { exists: false, indexed_files: [], total_vectors: 0 },
                fetchingIndexDetails: false,
                systemMetrics: {
                    cpu: { percent: 0, count: 0, available: 100 },
                    memory: { total_gb: 0, used_gb: 0, available_gb: 0, percent: 0 },
                    disk: { total_gb: 0, used_gb: 0, free_gb: 0, percent: 0 }
                },
                systemMetricsInterval: null,
                ollamaConnected: false,
                ollamaModels: [],
                selectedModel: '',
                embeddingModels: [],
                selectedEmbeddingModel: '',
                needsReindex: false,
                refreshingFiles: false,
                fetchingModels: false,
                visionAvailable: false,
                pendingImage: null,
                pendingImageData: null,
                isDragging: false,
                currentTheme: localStorage.getItem('familyrag-theme') || 'midnight',
                themes: [
                    { id: 'midnight', name: 'Midnight', accent: '#2563eb', accentDark: '#1e40af' },
                    { id: 'cyber', name: 'Cyber', accent: '#00d4ff', accentDark: '#0e7490' },
                    { id: 'tactical', name: 'Tactical', accent: '#ff3333', accentDark: '#b91c1c' }
                ],
                stats: { index: { exists: false, total_documents: 0, total_chunks: 0 }, settings: { llm_model: '', embedding_model: '', chunk_size: 0, chunk_overlap: 0, temperature: 0.7, top_k: 8 } },
                settings: { temperature: 0.7, top_k: 8 },

                // Conversation management
                sidebarOpen: false,
                conversations: [],
                currentConversationId: null,

                // Source selection
                showSourceSelection: false,
                selectedSources: [],

                async init() {
                    document.documentElement.setAttribute('data-theme', this.currentTheme);
                    await this.checkHealth();
                    await this.refreshFiles();
                    await this.fetchStats();
                    await this.fetchOllamaModels();
                    await this.fetchEmbeddingModels();
                    await this.fetchIndexDetails();
                    this.selectedModel = this.stats.settings.llm_model;
                    this.selectedEmbeddingModel = this.stats.settings.embedding_model;
                    this.checkVisionAvailable();
                    this.loadConversations();
                    this.newConversation();
                    setInterval(() => this.checkHealth(), 30000);

                    // D√©marrer le polling des m√©triques syst√®me
                    this.fetchSystemMetrics();
                    this.systemMetricsInterval = setInterval(() => this.fetchSystemMetrics(), 2000);
                },

                showNotification(type, title, message, icon = null) {
                    window.dispatchEvent(new CustomEvent('notify', {
                        detail: { type, title, message, icon }
                    }));
                },

                async fetchSystemMetrics() {
                    try {
                        this.systemMetrics = await (await fetch('/api/system/metrics')).json();
                    } catch (e) {
                        console.error('Erreur r√©cup√©ration m√©triques:', e);
                    }
                },

                checkVisionAvailable() {
                    const visionModels = ['ministral-3', 'ministral', 'llava', 'moondream'];
                    this.visionAvailable = this.ollamaModels.some(m => visionModels.some(v => m.name.toLowerCase().includes(v)));
                },

                handleFileSelect(event) {
                    const file = event.target.files[0];
                    if (file) this.processImageFile(file);
                },

                handleDrop(event) {
                    this.isDragging = false;
                    const file = event.dataTransfer.files[0];
                    if (file && file.type.startsWith('image/')) {
                        this.processImageFile(file);
                    }
                },

                processImageFile(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.pendingImage = e.target.result;
                        this.pendingImageData = e.target.result.split(',')[1];
                    };
                    reader.readAsDataURL(file);
                },

                clearPendingImage() {
                    this.pendingImage = null;
                    this.pendingImageData = null;
                },

                setTheme(id) {
                    this.currentTheme = id;
                    document.documentElement.setAttribute('data-theme', id);
                    localStorage.setItem('familyrag-theme', id);
                },

                // Conversation methods
                newConversation() {
                    const id = 'conv_' + Date.now();
                    // Par d√©faut, s√©lectionner TOUTES les sources pour √©viter les recherches vides
                    const defaultSources = this.files.map(f => f.name);
                    const conv = {
                        id: id,
                        title: 'Nouvelle conversation',
                        messages: [],
                        selectedSources: defaultSources,
                        timestamp: Date.now()
                    };
                    this.conversations.unshift(conv);
                    this.currentConversationId = id;
                    this.messages = [];
                    this.selectedSources = defaultSources;
                    this.showSourceSelection = false; // Ne pas afficher par d√©faut, toutes les sources sont d√©j√† s√©lectionn√©es
                    this.saveConversations();
                },

                loadConversation(id) {
                    const conv = this.conversations.find(c => c.id === id);
                    if (conv) {
                        this.currentConversationId = id;
                        this.messages = conv.messages || [];
                        this.selectedSources = conv.selectedSources || [];
                        this.sidebarOpen = false;
                        this.$nextTick(() => this.scrollChat());
                    }
                },

                deleteConversation(id) {
                    // Supprimer la conversation du tableau
                    const index = this.conversations.findIndex(c => c.id === id);
                    if (index !== -1) {
                        this.conversations.splice(index, 1);
                    }

                    // Si c'est la conversation active, cr√©er une nouvelle
                    if (this.currentConversationId === id) {
                        if (this.conversations.length > 0) {
                            // Charger la premi√®re conversation disponible
                            this.loadConversation(this.conversations[0].id);
                        } else {
                            // Cr√©er une nouvelle conversation
                            this.newConversation();
                        }
                    }

                    // Sauvegarder imm√©diatement
                    this.saveConversations();
                },

                saveConversations() {
                    localStorage.setItem('familyrag-conversations', JSON.stringify(this.conversations));
                },

                loadConversations() {
                    const saved = localStorage.getItem('familyrag-conversations');
                    if (saved) {
                        this.conversations = JSON.parse(saved);
                    }
                },

                updateCurrentConversation() {
                    const conv = this.conversations.find(c => c.id === this.currentConversationId);
                    if (conv) {
                        conv.messages = this.messages;
                        conv.selectedSources = this.selectedSources;
                        conv.timestamp = Date.now();
                        if (this.messages.length > 0) {
                            conv.title = this.messages[0].content.substring(0, 50) + '...';
                        }
                        this.saveConversations();
                    }
                },

                // Source selection
                selectAllSources() {
                    this.selectedSources = this.files.map(f => f.name);
                },

                deselectAllSources() {
                    this.selectedSources = [];
                },

                async sendMessage() {
                    if (this.loading) return;
                    if (!this.query.trim() && !this.pendingImage) return;

                    // V√©rifier qu'un mod√®le LLM est disponible (v√©rifier depuis les stats backend)
                    if (!this.stats.settings.llm_model || this.stats.settings.llm_model === '') {
                        this.showNotification('error', 'Aucun mod√®le LLM disponible', 'Veuillez installer un mod√®le LLM avec "ollama pull <modele>" puis le s√©lectionner dans les param√®tres.', 'ü§ñ');
                        return;
                    }

                    const question = this.query.trim() || "D√©cris cette image en d√©tail et extrait tout le texte visible.";
                    const hasImage = !!this.pendingImage;

                    // Add user message
                    this.messages.push({
                        type: 'user',
                        content: this.query.trim() || "Analyse cette image",
                        image: this.pendingImage
                    });

                    this.query = '';
                    this.loading = true;
                    this.abortController = new AbortController();
                    this.scrollChat();

                    try {
                        let response, data;

                        if (hasImage) {
                            // Vision analysis
                            response = await fetch('/api/vision/base64', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    image_data: this.pendingImageData,
                                    question: question
                                }),
                                signal: this.abortController.signal
                            });
                            data = await response.json();

                            if (data.success) {
                                this.messages.push({
                                    type: 'assistant',
                                    content: data.analysis,
                                    metrics: { time_ms: data.time_ms, model: data.model }
                                });
                            } else {
                                this.messages.push({ type: 'assistant', content: '‚ùå ' + data.error });
                            }
                        } else {
                            // RAG query
                            response = await fetch('/api/query', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    question: question,
                                    top_k: parseInt(this.settings.top_k),
                                    selected_sources: this.selectedSources
                                }),
                                signal: this.abortController.signal
                            });
                            data = await response.json();

                            if (response.ok) {
                                // Calculate confidence score (based on avg source score)
                                const avgScore = data.sources && data.sources.length > 0
                                    ? (data.sources.reduce((sum, s) => sum + (s.score || 0), 0) / data.sources.length * 100).toFixed(1)
                                    : null;

                                this.messages.push({
                                    type: 'assistant',
                                    content: data.answer,
                                    chunks_preview: data.chunks_preview || null,
                                    showDebug: false,
                                    metrics: {
                                        query_time_ms: data.metrics.query_time_ms,
                                        chunks_found: data.metrics.chunks_found,
                                        confidence: avgScore
                                    }
                                });
                            } else {
                                this.messages.push({ type: 'assistant', content: '‚ùå ' + (data.detail || 'Erreur') });
                            }
                        }
                    } catch (e) {
                        if (e.name === 'AbortError') {
                            this.messages.push({ type: 'assistant', content: '‚èπ G√©n√©ration interrompue' });
                        } else {
                            this.messages.push({ type: 'assistant', content: '‚ùå ' + e.message });
                        }
                    }

                    this.loading = false;
                    this.clearPendingImage();
                    this.updateCurrentConversation();
                    this.scrollChat();
                },

                stopGeneration() {
                    if (this.abortController) {
                        this.abortController.abort();
                    }
                },

                async checkHealth() {
                    try { const r = await fetch('/health'); this.ollamaConnected = (await r.json()).ollama_connected; } catch { this.ollamaConnected = false; }
                },

                async refreshFiles() {
                    this.refreshingFiles = true;
                    try { this.files = (await (await fetch('/api/files')).json()).files; } catch {}
                    this.refreshingFiles = false;
                },

                async fetchIndexDetails() {
                    this.fetchingIndexDetails = true;
                    try {
                        const response = await fetch('/api/index/details');
                        this.indexDetails = await response.json();
                    } catch (e) {
                        console.error('Erreur r√©cup√©ration d√©tails index:', e);
                        this.indexDetails = { exists: false, indexed_files: [], total_vectors: 0 };
                    }
                    this.fetchingIndexDetails = false;
                },

                selectAllFiles() {
                    this.selectedFiles = this.files.map(f => f.path);
                },

                deselectAllFiles() {
                    this.selectedFiles = [];
                },

                async fetchStats() {
                    try {
                        const d = await (await fetch('/api/stats')).json();
                        this.stats = d;
                        this.settings.temperature = d.settings.temperature;
                        this.settings.top_k = d.settings.top_k;
                        this.selectedModel = d.settings.llm_model;
                    } catch {}
                },

                async fetchOllamaModels() {
                    this.fetchingModels = true;
                    try {
                        this.ollamaModels = (await (await fetch('/api/ollama/models')).json()).models;
                        this.checkVisionAvailable();
                    } catch {
                        this.ollamaModels = [];
                    }
                    this.fetchingModels = false;
                },

                async fetchEmbeddingModels() {
                    try {
                        this.embeddingModels = (await (await fetch('/api/ollama/embedding-models')).json()).models;
                    } catch {
                        this.embeddingModels = [];
                    }
                },

                async indexDocuments() {
                    // Validation : v√©rifier qu'au moins un fichier est s√©lectionn√©
                    if (this.selectedFiles.length === 0) {
                        this.showNotification('warning', 'Aucun fichier s√©lectionn√©', 'Veuillez s√©lectionner au moins un fichier √† indexer.', 'üìã');
                        return;
                    }

                    this.indexing = true;
                    this.indexResult = null;
                    this.indexProgress = 0;
                    this.indexStatus = `Indexation de ${this.selectedFiles.length} fichier(s)...`;

                    // Cr√©er un AbortController pour permettre l'annulation
                    this.indexAbortController = new AbortController();

                    // Simuler la progression (l'API ne retourne pas de progression en temps r√©el)
                    const progressInterval = setInterval(() => {
                        if (this.indexProgress < 95) {
                            // Progression rapide jusqu'√† 90%, puis tr√®s lente apr√®s
                            if (this.indexProgress < 90) {
                                this.indexProgress += Math.random() * 10;
                                if (this.indexProgress > 90) this.indexProgress = 90;
                            } else {
                                // Apr√®s 90%, progression tr√®s lente pour montrer que √ßa travaille
                                this.indexProgress += Math.random() * 0.5;
                                if (this.indexProgress > 95) this.indexProgress = 95;
                            }

                            // Mettre √† jour le statut en fonction de la progression
                            if (this.indexProgress < 30) {
                                this.indexStatus = 'Chargement des documents...';
                            } else if (this.indexProgress < 60) {
                                this.indexStatus = 'D√©coupage en chunks...';
                            } else if (this.indexProgress < 90) {
                                this.indexStatus = 'Cr√©ation des embeddings...';
                            } else {
                                this.indexStatus = 'Finalisation de l\'index FAISS...';
                            }
                        }
                    }, 300);

                    try {
                        // Envoyer les fichiers s√©lectionn√©s au backend
                        const requestBody = this.selectedFiles.length === this.files.length
                            ? {}
                            : { selected_files: this.selectedFiles };

                        const r = await fetch('/api/index', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestBody),
                            signal: this.indexAbortController.signal
                        });
                        this.indexResult = await r.json();

                        clearInterval(progressInterval);
                        this.indexProgress = 100;
                        this.indexStatus = 'Indexation termin√©e !';

                        if (this.indexResult.success) {
                            await this.fetchStats();
                            await this.fetchIndexDetails();
                            // Masquer l'avertissement de r√©-indexation apr√®s indexation r√©ussie
                            this.needsReindex = false;
                            this.showNotification('success', 'Indexation r√©ussie', `${this.indexResult.documents} documents index√©s en ${this.indexResult.chunks} chunks`, '‚úÖ');
                        } else {
                            this.showNotification('error', 'Erreur d\'indexation', this.indexResult.error || 'Une erreur est survenue', '‚ùå');
                        }
                    } catch (e) {
                        clearInterval(progressInterval);
                        if (e.name === 'AbortError') {
                            this.indexResult = { success: false, error: 'Indexation suspendue par l\'utilisateur' };
                            this.showNotification('warning', 'Indexation suspendue', 'L\'indexation a √©t√© interrompue', '‚è∏');
                        } else {
                            this.indexResult = { success: false, error: e.message };
                            this.showNotification('error', 'Erreur d\'indexation', e.message, '‚ùå');
                        }
                    }

                    // Attendre un peu avant de masquer la barre de progression
                    await new Promise(resolve => setTimeout(resolve, 800));
                    this.indexing = false;
                    this.indexAbortController = null;
                },

                cancelIndexing() {
                    if (this.indexAbortController) {
                        this.indexAbortController.abort();
                        this.indexStatus = 'Suspension en cours...';
                    }
                },

                async updateSettings() {
                    try { await fetch('/api/settings', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ temperature: parseFloat(this.settings.temperature), top_k: parseInt(this.settings.top_k) }) }); } catch {}
                },

                async changeModel() {
                    if (!this.selectedModel) return;
                    try { const r = await fetch('/api/settings', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ llm_model: this.selectedModel }) }); if (r.ok) await this.fetchStats(); } catch {}
                },

                async changeEmbeddingModel() {
                    if (!this.selectedEmbeddingModel) return;
                    try {
                        const r = await fetch('/api/settings', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ embedding_model: this.selectedEmbeddingModel })
                        });
                        if (r.ok) {
                            const data = await r.json();
                            // Afficher l'avertissement de r√©-indexation si n√©cessaire
                            this.needsReindex = data.needs_reindex || false;
                            await this.fetchStats();
                        }
                    } catch (e) {
                        console.error('Erreur changement mod√®le embedding:', e);
                    }
                },

                scrollChat() { this.$nextTick(() => { const c = document.getElementById('chat-messages'); if (c) c.scrollTop = c.scrollHeight; }); },
                formatSize(b) { if (!b) return '0 B'; const k = 1024, s = ['B','KB','MB','GB'], i = Math.floor(Math.log(b)/Math.log(k)); return parseFloat((b/Math.pow(k,i)).toFixed(1))+' '+s[i]; },
                getFileIcon(t) { return { pdf:'üìï', txt:'üìÑ', md:'üìù', docx:'üìò', eml:'üìß', jpg:'üñºÔ∏è', jpeg:'üñºÔ∏è', png:'üñºÔ∏è' }[t] || 'üìé'; },
                formatTime(timestamp) {
                    const date = new Date(timestamp);
                    const now = new Date();
                    const diff = now - date;
                    const minutes = Math.floor(diff / 60000);
                    const hours = Math.floor(diff / 3600000);
                    const days = Math.floor(diff / 86400000);

                    if (minutes < 60) return minutes + 'min';
                    if (hours < 24) return hours + 'h';
                    return days + 'j';
                }
            };
        }
    </script>

    <!-- Notifications Toast -->
    <div class="toast" x-data="{ notifications: [] }" @notify.window="notifications.push($event.detail); setTimeout(() => notifications.shift(), 5000)">
        <template x-for="(notif, index) in notifications" :key="index">
            <div x-show="true" x-transition:enter="toast-enter" x-transition:leave="toast-leave"
                 class="mb-2 rounded-lg shadow-2xl overflow-hidden border-2 animate-pulse-border"
                 :class="{
                     'bg-red-900/95 border-red-500': notif.type === 'error',
                     'bg-orange-900/95 border-orange-500': notif.type === 'warning',
                     'bg-green-900/95 border-green-500': notif.type === 'success',
                     'bg-blue-900/95 border-blue-500': notif.type === 'info'
                 }">
                <div class="p-4">
                    <div class="flex items-start gap-3">
                        <span class="text-2xl flex-shrink-0" x-text="notif.icon || (notif.type === 'error' ? '‚ùå' : notif.type === 'warning' ? '‚ö†Ô∏è' : notif.type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è')"></span>
                        <div class="flex-1">
                            <h4 class="font-bold text-sm mb-1" x-text="notif.title"></h4>
                            <p class="text-xs opacity-90" x-text="notif.message"></p>
                        </div>
                        <button @click="notifications.splice(index, 1)" class="text-white/70 hover:text-white transition-colors">‚úï</button>
                    </div>
                </div>
            </div>
        </template>
    </div>
</body>
</html>
